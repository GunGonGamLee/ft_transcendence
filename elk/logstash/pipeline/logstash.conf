input {
	file {
		path => "/usr/share/logstash/log/nginx_logs/access_json.log"
		start_position => "beginning"
		codec => json
		tags => ["nginx"]
		id => "nginx_log"
	}
	file {
		path => "/usr/share/logstash/log/django_logs/django.log"
		start_position => "beginning"
		tags => ["django"]
		id => "django_log"
	}
}

filter {
	if "django" in [tags] {
		grok {
			match => {"message" => "\[인게임\] %{WORD:game_type}" }
		}
		if "_grokparsefailure" in [tags] {
			drop { }
		}
		mutate {
			remove_field => ["@version", "@timestamp", "host", "path"]
		}
	}
	if "nginx" in [tags] {
		grok {
			match => { "request" => "%{WORD:method} %{URIPATH:path} HTTP/%{NUMBER:httpversion}" }
		}
		mutate {
			convert => {
				"요청을 처리하는데 걸린 시간" => "float"
			}
		}
	}
}

output {
	if "django" in [tags] {
		elasticsearch {
			hosts => "https://elasticsearch:9200"
			index => "django-logs-%{+YYYY.MM.dd}"
			user => "elastic"
			password => "${ELASTIC_PW}"
			ssl => true
			ssl_certificate_verification => false
			keystore => "/usr/share/logstash/config/certs/elastic-certificates.p12"
			keystore_password => "${ES_CERTS_PW}"
			truststore => "/usr/share/logstash/config/certs/elastic-certificates.p12"
			truststore_password => "${ES_CERTS_PW}"
		}
	}
	if "nginx" in [tags] {
		elasticsearch {
			hosts => "https://elasticsearch:9200"
			index => "nginx-logs-%{+YYYY.MM.dd}"
			user => "elastic"
			password => "${ELASTIC_PW}"
			ssl => true
			ssl_certificate_verification => false
			keystore => "/usr/share/logstash/config/certs/elastic-certificates.p12"
			keystore_password => "${ES_CERTS_PW}"
			truststore => "/usr/share/logstash/config/certs/elastic-certificates.p12"
			truststore_password => "${ES_CERTS_PW}"
		}
	}
	elasticsearch {
		hosts => "https://elasticsearch:9200"
		index => "tscen-logs-%{+YYYY.MM.dd}"
		user => "elastic"
		password => "${ELASTIC_PW}"
		ssl => true
		ssl_certificate_verification => false
		keystore => "/usr/share/logstash/config/certs/elastic-certificates.p12"
		keystore_password => "${ES_CERTS_PW}"
		truststore => "/usr/share/logstash/config/certs/elastic-certificates.p12"
		truststore_password => "${ES_CERTS_PW}"
	}
}